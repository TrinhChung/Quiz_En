name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: QuizEn

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
          GEMINI_API_KEY="$GEMINI_API_KEY" << EOF
          set -euo pipefail
          set -x

          echo "üöÄ DEPLOY START"

          APP_DIR="/home/$SSH_USER/quiz-app"
          BACKUP_DIR="/home/$SSH_USER/quiz-app-backups"
          TS=\$(date +%Y%m%d_%H%M%S)

          mkdir -p "\$APP_DIR" "\$BACKUP_DIR"
          cd "\$APP_DIR"

          # --- Git ---
          if [ ! -d .git ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git fetch origin
            git reset --hard origin/main
          fi
          git status -sb
          git rev-parse HEAD

          # --- ENV ---
          if [ ! -f .env ]; then
            cat > .env << ENVEOF
          GEMINI_API_KEY=\$GEMINI_API_KEY
          SECRET_KEY=\$(openssl rand -hex 32)
          ENVEOF
          else
            sed -i "s/^GEMINI_API_KEY=.*/GEMINI_API_KEY=\$GEMINI_API_KEY/" .env
          fi
          ls -la .env

          # --- Docker info ---
          docker version
          docker compose version
          docker info

          # --- Backup state ---
          docker compose ps > "\$BACKUP_DIR/ps-\$TS.log" || true
          docker compose logs --tail=50 > "\$BACKUP_DIR/logs-\$TS.log" || true

          # --- Deploy ---
          docker compose down || true
          docker compose up -d --build
          docker compose ps

          echo "‚è≥ Waiting for container..."

          sleep 3

          # --- Health check (container) ---
          if ! docker compose ps | grep -q "Up"; then
            echo "‚ùå Container not running"
            docker compose ps -a
            docker compose logs --tail=200
            exit 1
          fi

          # --- Health check (app) ---
          for i in {1..10}; do
            if curl -fs http://localhost:1132 >/dev/null; then
              echo "‚úÖ App is healthy"
              break
            fi
            echo "‚è≥ Waiting app... (\$i/10)"
            sleep 2
          done

          if ! curl -fs http://localhost:1132 >/dev/null; then
            echo "‚ùå App health check failed"
            docker compose ps -a
            docker compose logs --tail=200
            docker compose down
            exit 1
          fi

          echo "üéâ DEPLOY SUCCESS"
          EOF
