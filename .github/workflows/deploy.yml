name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: QuizEn
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
          set -e
          
          echo "========== Deployment Started =========="
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          PROJECT_DIR="/home/$SSH_USER/quiz-app"
          BACKUP_DIR="/home/$SSH_USER/quiz-app-backups"
          
          # 1. Ki·ªÉm tra prerequisites
          echo "[1/7] Checking prerequisites..."
          if ! command -v git &> /dev/null; then
            echo "‚ùå Error: Git is not installed on VPS"
            exit 1
          fi
          
          if ! command -v docker &> /dev/null; then
            echo "‚ùå Error: Docker is not installed on VPS"
            exit 1
          fi
          
          echo "‚úì Git and Docker are installed"
          
          # 2. T·∫°o backup directory
          echo "[2/7] Creating backup directory..."
          mkdir -p "$BACKUP_DIR"
          
          # 3. Clone ho·∫∑c update code
          echo "[3/7] Updating repository..."
          if [ ! -d "$PROJECT_DIR" ]; then
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            git clone https://github.com/${{ github.repository }}.git . || { echo "‚ùå Clone failed"; exit 1; }
          else
            cd "$PROJECT_DIR"
            
            # Backup hi·ªán t·∫°i tr∆∞·ªõc khi update
            if [ -d "$PROJECT_DIR/.git" ]; then
              CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
              echo "Current commit: $CURRENT_COMMIT"
              
              # Backup docker-compose state
              docker compose ps > "$BACKUP_DIR/docker-state-$TIMESTAMP.log" 2>/dev/null || true
            fi
            
            git fetch origin || { echo "‚ùå Git fetch failed"; exit 1; }
            git reset --hard origin/main || { echo "‚ùå Git reset failed"; exit 1; }
          fi
          
          echo "‚úì Repository updated"
          
          # 4. Setup environment
          echo "[4/7] Setting up environment..."
          if [ ! -f .env ]; then
            echo "Creating .env file..."
            cat > .env << 'ENVEOF'
          GEMINI_API_KEY=$GEMINI_API_KEY
          SECRET_KEY=$(openssl rand -hex 32)
          ENVEOF
          else
            echo ".env file already exists, updating GEMINI_API_KEY..."
            sed -i "s/^GEMINI_API_KEY=.*/GEMINI_API_KEY=$GEMINI_API_KEY/" .env
          fi
          
          echo "‚úì Environment configured"
          
          # 5. Backup current containers
          echo "[5/7] Backing up current state..."
          docker compose ps > "$BACKUP_DIR/before-deploy-$TIMESTAMP.log" 2>/dev/null || true
          docker compose logs --tail=100 > "$BACKUP_DIR/logs-before-$TIMESTAMP.log" 2>/dev/null || true
          
          # 6. Deploy dengan fallback
          echo "[6/7] Deploying application..."
          if docker compose down 2>&1 | tee "$BACKUP_DIR/shutdown-$TIMESTAMP.log"; then
            echo "‚úì Old containers stopped"
          else
            echo "‚ö† Warning: Could not stop old containers, continuing..."
          fi
          
          if docker compose up -d --build 2>&1 | tee "$BACKUP_DIR/deploy-$TIMESTAMP.log"; then
            echo "‚úì New containers started"
          else
            echo "‚ùå Container startup failed!"
            docker compose logs >> "$BACKUP_DIR/error-$TIMESTAMP.log" 2>&1
            exit 1
          fi
          
          # 7. Health check
          echo "[7/7] Performing health checks..."
          sleep 3
          
          # Check if container is running
          if docker compose ps | grep -q "quiz-app.*Up"; then
            echo "‚úì Container is running"
          else
            echo "‚ùå Container failed to start!"
            docker compose logs >> "$BACKUP_DIR/error-$TIMESTAMP.log" 2>&1
            docker compose down || true
            exit 1
          fi
          
          # Check application endpoint
          MAX_RETRIES=10
          RETRY=0
          while [ $RETRY -lt $MAX_RETRIES ]; do
            if curl -s http://localhost:1132 > /dev/null 2>&1; then
              echo "‚úì Application is responding on port 1132"
              break
            fi
            RETRY=$((RETRY + 1))
            if [ $RETRY -lt $MAX_RETRIES ]; then
              echo "  Waiting for app to be ready... ($RETRY/$MAX_RETRIES)"
              sleep 2
            fi
          done
          
          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "‚ùå Application health check failed after $MAX_RETRIES attempts!"
            docker compose logs >> "$BACKUP_DIR/error-$TIMESTAMP.log" 2>&1
            docker compose down || true
            exit 1
          fi
          
          # Save deployment info
          echo "‚úì All health checks passed"
          
          echo ""
          echo "========== Deployment Completed =========="
          echo "‚úÖ Application deployed successfully!"
          echo "üìç Application running on: http://$SSH_HOST:1132"
          echo "üìÖ Deployment time: $(date)"
          echo "üì¶ Backup location: $BACKUP_DIR/docker-state-$TIMESTAMP.log"
          echo ""
          echo "Deployment logs saved to:"
          echo "  - Before: $BACKUP_DIR/before-deploy-$TIMESTAMP.log"
          echo "  - Deploy: $BACKUP_DIR/deploy-$TIMESTAMP.log"
          
          EOF

      - name: Verify Deployment Status
        if: always()
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
          PROJECT_DIR="/home/$SSH_USER/quiz-app"
          cd "$PROJECT_DIR"
          
          echo "========== Deployment Status Check =========="
          echo ""
          echo "Container Status:"
          docker compose ps
          echo ""
          echo "Recent Logs (last 20 lines):"
          docker compose logs --tail=20
          echo ""
          echo "========== End Status Check =========="
          EOF

      - name: Notify on Failure
        if: failure()
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs on VPS at: /home/$SSH_USER/quiz-app-backups/"
          
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
          PROJECT_DIR="/home/$SSH_USER/quiz-app"
          BACKUP_DIR="/home/$SSH_USER/quiz-app-backups"
          
          echo "Collecting error logs..."
          mkdir -p "$BACKUP_DIR"
          
          if [ -d "$PROJECT_DIR" ]; then
            cd "$PROJECT_DIR"
            docker compose logs > "$BACKUP_DIR/deployment-error-$(date +%Y%m%d_%H%M%S).log" 2>&1 || true
            docker ps -a >> "$BACKUP_DIR/deployment-error-$(date +%Y%m%d_%H%M%S).log" 2>&1 || true
          fi
          EOF
          
          exit 1
