{% extends "base.html" %}

{% block title %}Quiz Management - Quiz App{% endblock %}

{% block extra_css %}
<style>
    .management-layout {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
    }

    .form-section {
        position: sticky;
        top: 2rem;
        height: fit-content;
    }

    .list-section {
        width: 100%;
    }

    @media (max-width: 1024px) {
        .management-layout {
            grid-template-columns: 1fr;
        }

        .form-section {
            position: static;
        }
    }

    .form-card h2 {
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
    }

    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .list-header h2 {
        margin: 0;
    }

    .list-stats {
        display: flex;
        gap: 1rem;
    }

    .stat-badge {
        background: #667eea;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .alert {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üìö Quiz Management</h1>
    <p>Create, edit, and manage your quiz questions</p>
</div>

<div class="management-layout">
    <!-- Form Section -->
    <div class="form-section">
        <div class="form-card">
            <h2 id="form-title">Create New Quiz</h2>
            <p class="alert alert-info" id="status" style="display: none;"></p>
            
            <form id="quiz-form">
                <input type="hidden" id="quiz-id" />
                
                <div class="form-group">
                    <label for="question">Question *</label>
                    <textarea id="question" rows="3" required placeholder="Enter your question here..."></textarea>
                </div>

                <div class="form-group">
                    <label for="options">Options (comma-separated) *</label>
                    <textarea id="options" rows="3" required placeholder="Option 1, Option 2, Option 3, Option 4"></textarea>
                </div>

                <div class="form-group">
                    <label for="answer">Correct Answer *</label>
                    <input type="text" id="answer" required placeholder="Enter the correct answer...">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Save Quiz</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                    <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;" onclick="cancelEdit()">Cancel Edit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- List Section -->
    <div class="list-section">
        <div class="card">
            <div class="list-header">
                <h2>Your Quizzes</h2>
                <div class="list-stats">
                    <span class="stat-badge" id="quiz-count">0 quizzes</span>
                </div>
            </div>

            <div id="quiz-list-container">
                <div class="empty-state">
                    <p class="empty-icon">üìù</p>
                    <p class="empty-message">No quizzes created yet. Create your first quiz!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Form submission
    document.getElementById('quiz-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            question: document.getElementById('question').value,
            options: document.getElementById('options').value.split(',').map(o => o.trim()),
            answer: document.getElementById('answer').value,
        };

        const quizId = document.getElementById('quiz-id').value;
        const endpoint = quizId ? `/api/quiz/${quizId}` : '/api/quiz';
        const method = quizId ? 'PUT' : 'POST';

        try {
            const res = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await res.json();

            if (res.ok) {
                showStatus(`‚úÖ ${quizId ? 'Quiz updated' : 'Quiz created'} successfully!`, 'success');
                resetForm();
                loadQuizzes();
            } else {
                showStatus(`‚ùå Error: ${result.message || 'Failed to save'}`, 'error');
            }
        } catch (err) {
            showStatus(`‚ùå Error: ${err.message}`, 'error');
        }
    });

    function resetForm() {
        document.getElementById('quiz-form').reset();
        document.getElementById('quiz-id').value = '';
        document.getElementById('form-title').textContent = 'Create New Quiz';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    function cancelEdit() {
        resetForm();
    }

    async function editQuiz(id) {
        try {
            const res = await fetch(`/api/quiz/${id}`);
            const quiz = await res.json();

            document.getElementById('quiz-id').value = quiz.id;
            document.getElementById('question').value = quiz.question;
            document.getElementById('options').value = quiz.options.join(', ');
            document.getElementById('answer').value = quiz.answer;
            document.getElementById('form-title').textContent = 'Edit Quiz';
            document.getElementById('cancel-btn').style.display = 'inline-block';

            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            showStatus(`‚ùå Error loading quiz: ${err.message}`, 'error');
        }
    }

    async function deleteQuiz(id) {
        if (!confirm('Are you sure you want to delete this quiz?')) return;

        try {
            const res = await fetch(`/api/quiz/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showStatus('‚úÖ Quiz deleted successfully!', 'success');
                loadQuizzes();
            }
        } catch (err) {
            showStatus(`‚ùå Error: ${err.message}`, 'error');
        }
    }

    async function loadQuizzes() {
        try {
            const res = await fetch('/api/quizzes');
            const quizzes = await res.json();

            const container = document.getElementById('quiz-list-container');
            document.getElementById('quiz-count').textContent = `${quizzes.length} quiz${quizzes.length !== 1 ? 'zes' : ''}`;

            if (quizzes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p class="empty-icon">üìù</p>
                        <p class="empty-message">No quizzes created yet. Create your first quiz!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = quizzes.map(quiz => `
                <div class="quiz-list-item">
                    <div class="quiz-list-info">
                        <h4>${quiz.question.substring(0, 60)}${quiz.question.length > 60 ? '...' : ''}</h4>
                        <p class="quiz-meta">
                            <span class="badge">${quiz.options.length} options</span>
                            <span class="badge meta-time">${new Date(quiz.created_at).toLocaleDateString()}</span>
                        </p>
                    </div>
                    <div class="quiz-list-actions">
                        <a href="/quiz/${quiz.id}" class="btn btn-primary btn-small">Start</a>
                        <button class="btn btn-secondary btn-small" onclick="editQuiz('${quiz.id}')">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteQuiz('${quiz.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            showStatus(`‚ùå Error loading quizzes: ${err.message}`, 'error');
        }
    }

    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `alert alert-${type}`;
        statusEl.style.display = 'block';
        setTimeout(() => statusEl.style.display = 'none', 5000);
    }

    // Load on page load
    loadQuizzes();
</script>
{% endblock %}
            <button type="button" class="btn btn-secondary" onclick="resetForm()">New Quiz</button>
        </div>
    </form>
</div>

<!-- Quiz List -->
<div class="card" id="quizzes">
    <h2>All Quizzes</h2>
    <p id="no-quizzes" style="color: #666;">Loading quizzes...</p>
    <div id="quizzes-list"></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const statusEl = document.getElementById('status');
    const quizForm = document.getElementById('quiz-form');
    const quizIdEl = document.getElementById('quiz-id');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const answerEl = document.getElementById('answer');
    const quizzesList = document.getElementById('quizzes-list');
    const noQuizzesEl = document.getElementById('no-quizzes');

    // Load quizzes
    async function loadQuizzes() {
        try {
            const response = await fetch('/api/quizzes');
            const quizzes = await response.json();
            
            if (quizzes.length === 0) {
                noQuizzesEl.textContent = 'No quizzes yet. Create one to get started!';
                quizzesList.innerHTML = '';
                return;
            }

            noQuizzesEl.style.display = 'none';
            quizzesList.innerHTML = quizzes.map(quiz => `
                <div class="quiz-item">
                    <div class="quiz-info">
                        <h3>${escapeHtml(quiz.question)}</h3>
                        <p>${quiz.options.length} options ‚Ä¢ ID: ${quiz.id}</p>
                    </div>
                    <div class="quiz-actions">
                        <button class="btn btn-primary btn-small" onclick="editQuiz(${quiz.id})">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteQuiz(${quiz.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            noQuizzesEl.textContent = 'Error loading quizzes';
            console.error(e);
        }
    }

    // Save quiz
    quizForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const quizId = quizIdEl.value;
        const question = questionEl.value.trim();
        const options = optionsEl.value.trim().split(',').map(o => o.trim()).filter(o => o);
        const answer = answerEl.value.trim();

        if (!question || options.length < 2 || !answer) {
            showStatus('Please fill all fields correctly', 'error');
            return;
        }

        try {
            const method = quizId ? 'PUT' : 'POST';
            const url = quizId ? `/api/quizzes/${quizId}` : '/api/quizzes';
            
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, options, answer })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.errors?.question || 'Error saving quiz');
            }

            const quiz = await response.json();
            showStatus(quizId ? 'Quiz updated!' : 'Quiz created!', 'success');
            resetForm();
            loadQuizzes();
        } catch (e) {
            showStatus(`Error: ${e.message}`, 'error');
        }
    });

    // Edit quiz
    async function editQuiz(id) {
        try {
            const response = await fetch(`/api/quizzes/${id}`);
            const quiz = await response.json();

            quizIdEl.value = id;
            questionEl.value = quiz.question;
            optionsEl.value = quiz.options.join(', ');
            answerEl.value = quiz.answer;

            questionEl.focus();
            window.scrollTo(0, 0);
        } catch (e) {
            showStatus('Error loading quiz', 'error');
        }
    }

    // Delete quiz
    async function deleteQuiz(id) {
        if (!confirm('Are you sure?')) return;

        try {
            const response = await fetch(`/api/quizzes/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Delete failed');

            showStatus('Quiz deleted!', 'success');
            loadQuizzes();
        } catch (e) {
            showStatus(`Error: ${e.message}`, 'error');
        }
    }

    // Reset form
    function resetForm() {
        quizForm.reset();
        quizIdEl.value = '';
    }

    // Show status
    function showStatus(message, type) {
        statusEl.textContent = message;
        statusEl.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
        statusEl.style.display = 'block';
        setTimeout(() => statusEl.style.display = 'none', 4000);
    }

    // Escape HTML
    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    loadQuizzes();
</script>
{% endblock %}
