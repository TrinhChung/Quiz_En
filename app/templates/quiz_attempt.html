{% extends "base.html" %}

{% block title %}Take Quiz - Quiz App{% endblock %}

{% block extra_css %}
<style>
    .quiz-container {
        max-width: 700px;
        margin: 0 auto;
    }

    .quiz-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .quiz-header h1 {
        color: #667eea;
        margin-bottom: 0.5rem;
    }

    .result-summary {
        display: none;
        background: white;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        margin-top: 2rem;
    }

    .result-score {
        font-size: 3rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 1rem;
    }

    .result-message {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 2rem;
    }

    .answer-review {
        display: none;
        margin-top: 2rem;
    }

    .answer-review-item {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #ddd;
    }

    .answer-review-item.correct {
        border-left-color: #48bb78;
    }

    .answer-review-item.incorrect {
        border-left-color: #f56565;
    }

    .review-question {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .review-answer {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f9f9f9;
        border-radius: 4px;
    }

    .user-answer {
        color: #f56565;
    }

    .correct-answer {
        color: #48bb78;
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="quiz-header">
        <h1>üìù Quiz</h1>
        <p>Answer each question carefully</p>
    </div>

    {% if quiz %}
    <!-- Quiz Attempt Form -->
    <div id="quiz-form-container" class="quiz-attempt-card">
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%"></div>
            <span class="progress-text" id="progress-text">Question 1 of {{ quiz.questions|length }}</span>
        </div>

        <div class="quiz-question">
            <h2 id="question-text"></h2>
        </div>

        <form id="quiz-answer-form" class="quiz-options"></form>

        <div class="quiz-controls">
            <button id="prev-btn" class="btn btn-secondary" style="display: none;">‚Üê Previous</button>
            <button id="next-btn" class="btn btn-primary">Next ‚Üí</button>
            <button id="submit-btn" class="btn btn-success" style="display: none;">Submit Quiz</button>
        </div>
    </div>

    <!-- Result Summary -->
    <div id="result-summary" class="result-summary">
        <div class="result-score" id="score-display">0/0</div>
        <div class="result-message" id="result-message"></div>
        <a href="/quizzes" class="btn btn-primary">Back to Quizzes</a>
    </div>

    <!-- Answer Review -->
    <div id="answer-review" class="answer-review">
        <h3>Answer Review</h3>
        <div id="review-container"></div>
    </div>

    {% endif %}
</div>

<script>
    const quizData = {{ quiz | tojson | safe }};
    let currentQuestion = 0;
    let userAnswers = {};

    // Ë≥™Âïè„ÇíË°®Á§∫
    function showQuestion(index) {
        if (index >= quizData.questions.length) {
            index = quizData.questions.length - 1;
        }
        currentQuestion = index;

        const q = quizData.questions[index];
        document.getElementById('question-text').textContent = q.question;

        // „Ç™„Éó„Ç∑„Éß„É≥ÁîüÊàê
        const form = document.getElementById('quiz-answer-form');
        form.innerHTML = '';
        q.options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'option-radio';
            if (userAnswers[index] === option) {
                label.classList.add('selected');
            }
            label.innerHTML = `
                <input type="radio" name="answer" value="${option}" 
                    ${userAnswers[index] === option ? 'checked' : ''}>
                <span class="option-label">${option}</span>
            `;
            label.querySelector('input').addEventListener('change', function() {
                userAnswers[index] = this.value;
                document.querySelectorAll('.option-radio').forEach(l => l.classList.remove('selected'));
                label.classList.add('selected');
            });
            form.appendChild(label);
        });

        // „Éú„Çø„É≥Ë°®Á§∫Âàá„ÇäÊõø„Åà
        document.getElementById('prev-btn').style.display = index > 0 ? 'block' : 'none';
        document.getElementById('next-btn').style.display = index < quizData.questions.length - 1 ? 'block' : 'none';
        document.getElementById('submit-btn').style.display = index === quizData.questions.length - 1 ? 'block' : 'none';

        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
        const progress = ((index + 1) / quizData.questions.length) * 100;
        document.getElementById('progress').style.width = progress + '%';
        document.getElementById('progress-text').textContent = `Question ${index + 1} of ${quizData.questions.length}`;
    }

    // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentQuestion > 0) showQuestion(currentQuestion - 1);
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        if (currentQuestion < quizData.questions.length - 1) showQuestion(currentQuestion + 1);
    });

    document.getElementById('submit-btn').addEventListener('click', submitQuiz);

    function submitQuiz() {
        // „Çπ„Ç≥„Ç¢Ë®àÁÆó
        let correct = 0;
        quizData.questions.forEach((q, i) => {
            if (userAnswers[i] === q.answer) correct++;
        });

        const percentage = Math.round((correct / quizData.questions.length) * 100);
        
        // ÁµêÊûúË°®Á§∫
        document.getElementById('quiz-form-container').style.display = 'none';
        document.getElementById('result-summary').style.display = 'block';
        document.getElementById('score-display').textContent = `${correct}/${quizData.questions.length}`;
        
        if (percentage >= 80) {
            document.getElementById('result-message').textContent = 'üéâ Excellent! You passed!';
        } else if (percentage >= 60) {
            document.getElementById('result-message').textContent = 'üëç Good job!';
        } else {
            document.getElementById('result-message').textContent = 'üìö Keep practicing!';
        }

        // Á≠î„Åà„É¨„Éì„É•„ÉºË°®Á§∫
        showAnswerReview(correct, percentage);
    }

    function showAnswerReview(correct, percentage) {
        document.getElementById('answer-review').style.display = 'block';
        const reviewContainer = document.getElementById('review-container');
        reviewContainer.innerHTML = '';

        quizData.questions.forEach((q, i) => {
            const isCorrect = userAnswers[i] === q.answer;
            const item = document.createElement('div');
            item.className = `answer-review-item ${isCorrect ? 'correct' : 'incorrect'}`;
            item.innerHTML = `
                <div class="review-question">Q${i + 1}: ${q.question}</div>
                <div class="review-answer">
                    Your answer: <span class="${isCorrect ? 'correct-answer' : 'user-answer'}">${userAnswers[i] || 'Not answered'}</span>
                    ${!isCorrect ? `<br>Correct answer: <span class="correct-answer">${q.answer}</span>` : '‚úì'}
                </div>
            `;
            reviewContainer.appendChild(item);
        });
    }

    // ÂàùÊúüÂåñ
    showQuestion(0);
</script>
{% endblock %}
